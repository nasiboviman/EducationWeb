<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Management</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">

    <h2 class="text-center mb-4">Student Management System</h2>

    <!-- SEARCH -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2">
                <div class="col"><input id="searchName" class="form-control" placeholder="Name"></div>
                <div class="col"><input id="searchSurname" class="form-control" placeholder="Surname"></div>
                <div class="col"><input id="searchAge" type="number" class="form-control" placeholder="Age"></div>
                <div class="col">
                    <button class="btn btn-primary w-100" onclick="loadStudents()">Search</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE BUTTON -->
    <button class="btn btn-success mb-3" onclick="openCreateModal()">âž• Add Student</button>

    <!-- TABLE -->
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Surname</th>
            <th>Age</th>
            <th>Scholarship</th>
            <th>University</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="studentsTable"></tbody>
    </table>
</div>

<!-- ================= CREATE / UPDATE MODAL ================= -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Create Student</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="studentId">

                <div class="row g-2">
                    <div class="col-md-6">
                        <input id="name" class="form-control" placeholder="Name">
                    </div>
                    <div class="col-md-6">
                        <input id="surname" class="form-control" placeholder="Surname">
                    </div>
                    <div class="col-md-4">
                        <input id="age" type="number" class="form-control" placeholder="Age">
                    </div>
                    <div class="col-md-4">
                        <input id="scholarship" type="number" class="form-control" placeholder="Scholarship">
                    </div>
                    <div class="col-md-4">
                        <input id="universityId" type="number" class="form-control" placeholder="University ID">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-success" onclick="saveStudent()">Save</button>
            </div>

        </div>
    </div>
</div>

<!-- ================= DELETE CONFIRM MODAL ================= -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to delete this student?
                <input type="hidden" id="deleteStudentId">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>

        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = "http://localhost:8080/api/students";

    const studentModal = new bootstrap.Modal(document.getElementById("studentModal"));
    const deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));

    /* ================= LOAD ================= */
    function loadStudents() {
        const name = searchName.value;
        const surname = searchSurname.value;
        const age = searchAge.value;

        let url = API_URL + "?";
        if (name) url += `name=${name}&`;
        if (surname) url += `surname=${surname}&`;
        if (age) url += `age=${age}&`;

        fetch(url)
            .then(r => r.json())
            .then(res => {
                studentsTable.innerHTML = "";
                res.data.forEach(s => {
                    studentsTable.innerHTML += `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.surname}</td>
                    <td>${s.age}</td>
                    <td>${s.scholarship}</td>
                    <td>${s.university?.name}</td>
                    <td>
                        <button class="btn btn-sm btn-warning"
                            onclick='openEditModal(${JSON.stringify(s)})'>Edit</button>
                        <button class="btn btn-sm btn-danger"
                            onclick="openDeleteModal(${s.id})">Delete</button>
                    </td>
                </tr>`;
                });
            });
    }

    /* ================= CREATE ================= */
    function openCreateModal() {
        modalTitle.innerText = "Create Student";
        studentId.value = "";
        document.querySelectorAll("#studentModal input").forEach(i => i.value = "");
        studentModal.show();
    }

    /* ================= EDIT ================= */
    function openEditModal(student) {
        modalTitle.innerText = "Update Student";
        studentId.value = student.id;
        name.value = student.name;
        surname.value = student.surname;
        age.value = student.age;
        scholarship.value = student.scholarship;
        universityId.value = student.university?.id;
        studentModal.show();
    }

    /* ================= SAVE ================= */
    function saveStudent() {
        const id = studentId.value;

        const student = {
            name: name.value,
            surname: surname.value,
            age: age.value,
            scholarship: scholarship.value,
            universityId: universityId.value
        };

        fetch(id ? `${API_URL}/${id}` : API_URL, {
            method: id ? "PUT" : "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(student)
        })
            .then(() => {
                studentModal.hide();
                loadStudents();
            });
    }

    /* ================= DELETE ================= */
    function openDeleteModal(id) {
        deleteStudentId.value = id;
        deleteModal.show();
    }

    function confirmDelete() {
        const id = deleteStudentId.value;

        fetch(`${API_URL}/${id}`, {method: "DELETE"})
            .then(() => {
                deleteModal.hide();
                loadStudents();
            });
    }

    loadStudents();
</script>

</body>
</html>
